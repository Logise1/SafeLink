<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoopChat</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6366F1"/>
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="LoopChat">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Biblioteca para generar códigos QR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Biblioteca para escanear códigos QR -->
    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <!-- Fuente Inter de Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --brand-color: #6366F1; /* Indigo-500 */
            --brand-color-light: #E0E7FF; /* Indigo-100 */
            --brand-color-dark: #4338CA; /* Indigo-700 */
        }
        html, body {
            height: 100%;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }
        body { 
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to bottom right, #f3e8ff, #dbeafe);
        }
        .screen { display: none; }
        .active-screen { display: flex; }

        .app-container {
            height: 100vh;
            height: calc(var(--vh, 1vh) * 100);
            background-color: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .glass-modal {
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(15px);
             -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        .glass-card {
             background-color: rgba(255, 255, 255, 0.5);
             border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .message {
            max-width: 75%; padding: 10px 14px; border-radius: 20px; margin-bottom: 4px;
            word-wrap: break-word; display: flex; flex-direction: column;
        }
        .sent {
            background-color: var(--brand-color); color: white; align-self: flex-end;
            border-bottom-right-radius: 6px;
        }
        .received {
            background-color: #F3F4F6; color: #111827; align-self: flex-start;
            border-bottom-left-radius: 6px;
        }
        .timestamp { font-size: 0.7rem; color: #ffffff99; align-self: flex-end; margin-top: 4px; }
        .received .timestamp { color: #6B7280; }
        
        audio {
            filter: sepia(20%) saturate(70%) grayscale(1) contrast(99%) invert(12%);
            border-radius: 25px;
        }

        #qrcode-container img, #qrcode-container canvas { margin: auto; }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }
        .typing-indicator span {
            animation: bounce 1.2s infinite ease-in-out; display: inline-block;
            width: 6px; height: 6px; background-color: #9CA3AF; border-radius: 50%; margin: 0 1px;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        .toggle-checkbox:checked { right: 0; border-color: var(--brand-color); }
        .toggle-checkbox:checked + .toggle-label { background-color: var(--brand-color); }
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center">

    <div class="app-container w-full max-w-md mx-auto md:rounded-2xl shadow-lg flex flex-col">
        
        <!-- Pantalla de Carga -->
        <div id="loading-screen" class="screen active-screen flex-1 flex-col items-center justify-center p-6 md:p-8">
             <svg class="animate-spin h-10 w-10 text-[var(--brand-color)]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-gray-600 font-medium">Cargando LoopChat...</p>
        </div>

        <!-- Pantalla de Bienvenida y Registro Unificada -->
        <div id="welcome-screen" class="screen flex-1 flex-col items-center justify-center text-center p-6 md:p-8">
            <div id="welcome-main" class="w-full">
                <div class="bg-[var(--brand-color-light)] p-4 rounded-full mb-4 inline-block">
                    <svg class="w-10 h-10 text-[var(--brand-color)]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                </div>
                <h1 class="text-3xl font-bold text-gray-900">Bienvenido a LoopChat</h1>
                <p class="text-gray-500 mt-2 mb-8">Un espacio seguro para que los niños conecten.</p>
                <button id="show-parent-onboarding" class="w-full bg-[var(--brand-color)] text-white font-bold py-3 px-4 rounded-xl hover:bg-[var(--brand-color-dark)] transition duration-300 shadow-sm">Soy Padre</button>
                <button id="show-child-register" class="w-full mt-3 bg-gray-200 text-gray-800 font-bold py-3 px-4 rounded-xl hover:bg-gray-300 transition duration-300">Soy Hijo</button>
                <p class="mt-6 text-sm text-gray-500">¿Ya tienes cuenta? <a href="#" id="show-login" class="font-semibold text-[var(--brand-color)] hover:underline">Inicia Sesión</a></p>
            </div>
            
            <div id="parent-onboarding-container" class="hidden w-full text-center">
                <div id="onboarding-slide-1" class="onboarding-slide">
                    <div class="bg-indigo-100 p-4 rounded-full mb-6 inline-block">
                       <svg class="w-10 h-10 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.6-3.751A11.959 11.959 0 0112 2.764h.001z" /></svg>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800">Conexiones Seguras</h2>
                    <p class="text-gray-500 mt-2">Los amigos solo se pueden añadir en persona, escaneando un código QR único que cambia constantemente.</p>
                </div>
                <div id="onboarding-slide-2" class="onboarding-slide hidden">
                    <div class="bg-indigo-100 p-4 rounded-full mb-6 inline-block">
                        <svg class="w-10 h-10 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.343 3.94c.09-.542.56-.94 1.11-.94h1.093c.55 0 1.02.398 1.11.94l.149.894c.07.424.384.764.78.93.398.164.855.142 1.205-.108l.737-.527a1.125 1.125 0 011.45.12l.773.774c.39.389.44 1.002.12 1.45l-.527.737c-.25.35-.272.806-.108 1.204.165.399.505.71.93.78l.893.15c.543.09.94.56.94 1.11v1.093c0 .55-.397 1.02-.94 1.11l-.893.149c-.425.07-.765.383-.93.78-.165.398-.143.854.108 1.204l.527.738c.32.447.27.96-.12 1.45l-.774.773a1.125 1.125 0 01-1.449.12l-.738-.527c-.35-.25-.806-.272-1.203-.107-.399.165-.71.505-.781.93l-.15.894c-.09.542-.56.94-1.11.94h-1.094c-.55 0-1.019-.398-1.11-.94l-.149-.894c-.07-.424-.384-.764-.78-.93-.398-.164-.855-.142-1.205.108l-.737.527a1.125 1.125 0 01-1.45-.12l-.773-.774a1.125 1.125 0 01-.12-1.45l.527-.737c.25-.35.272-.806.108-1.204-.165-.399-.505-.71-.93-.78l-.894-.15c-.542-.09-.94-.56-.94-1.11v-1.094c0-.55.398-1.02.94-1.11l.894-.149c.424-.07.765-.383.93-.78.165-.398.143-.854-.108-1.204l-.526-.738a1.125 1.125 0 01.12-1.45l.773-.773a1.125 1.125 0 011.45-.12l.737.527c.35.25.807.272 1.204.107.399-.165.71-.505.78-.93l.15-.893z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800">Control Total en tus Manos</h2>
                    <p class="text-gray-500 mt-2">Establece límites de tiempo, filtra contenido inapropiado y decide si tu hijo puede añadir amigos.</p>
                </div>
                <div id="onboarding-slide-3" class="onboarding-slide hidden">
                     <div class="bg-indigo-100 p-4 rounded-full mb-6 inline-block">
                        <svg class="w-10 h-10 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639l4.43-7.563A2 2 0 018.154 3h7.692a2 2 0 011.685.823l4.43 7.563a1.012 1.012 0 010 .639l-4.43 7.563A2 2 0 0115.846 21H8.154a2 2 0 01-1.685-.823l-4.43-7.563z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 12.75a2.25 2.25 0 100-4.5 2.25 2.25 0 000 4.5z" /></svg>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800">Supervisión Constante</h2>
                     <p class="text-gray-500 mt-2">Revisa las conversaciones y la lista de amigos de tus hijos para garantizar su seguridad en todo momento.</p>
                </div>

                <div class="mt-8">
                    <button id="next-onboarding-slide" class="w-full bg-[var(--brand-color)] text-white font-bold py-3 px-4 rounded-xl hover:bg-[var(--brand-color-dark)] transition duration-300 shadow-sm">Siguiente</button>
                    <p class="mt-4 text-sm text-gray-500 text-center"><a href="#" id="onboarding-go-back" class="font-semibold text-[var(--brand-color)] hover:underline">Volver</a></p>
                </div>
            </div>
            <!-- Formularios de registro post-onboarding -->
            <div id="parent-register-container" class="hidden w-full text-left">
                <h2 class="text-2xl font-bold text-gray-800 text-center mb-6">Registro para Padres</h2>
                <form id="parent-register-form" class="space-y-4">
                    <input type="text" id="parent-name" placeholder="Nombre completo" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--brand-color)]">
                    <input type="email" id="parent-email" placeholder="Correo electrónico" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--brand-color)]">
                    <input type="password" id="parent-password" placeholder="Contraseña" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--brand-color)]">
                    <button type="submit" class="w-full bg-[var(--brand-color)] text-white font-bold py-3 rounded-lg hover:bg-[var(--brand-color-dark)] transition duration-300">Crear Cuenta</button>
                </form>
                <p class="mt-4 text-sm text-gray-500 text-center"><a href="#" class="go-back font-semibold text-[var(--brand-color)] hover:underline">Volver</a></p>
            </div>
            <div id="child-register-container" class="hidden w-full text-left">
                <h2 class="text-2xl font-bold text-gray-800 text-center mb-6">Registro para Hijos</h2>
                <form id="child-register-form" class="space-y-4">
                    <input type="text" id="parent-code" placeholder="Código del Padre" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--brand-color)]">
                    <input type="text" id="child-name" placeholder="Tu nombre" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--brand-color)]">
                    <input type="password" id="child-password" placeholder="Tu contraseña" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--brand-color)]">
                    <button type="submit" class="w-full bg-[var(--brand-color)] text-white font-bold py-3 rounded-lg hover:bg-[var(--brand-color-dark)] transition duration-300">Unirme</button>
                </form>
                <p class="mt-4 text-sm text-gray-500 text-center"><a href="#" class="go-back font-semibold text-[var(--brand-color)] hover:underline">Volver</a></p>
            </div>
        </div>
        
        <div id="login-screen" class="screen flex-1 flex-col p-6 md:p-8 justify-center">
            <h2 class="text-2xl font-bold text-gray-800">Iniciar Sesión</h2>
            <div class="w-full flex border-b mt-6">
                <button id="login-parent-tab" class="flex-1 font-semibold py-2 border-b-2 border-[var(--brand-color)] text-[var(--brand-color)]">Soy Padre</button>
                <button id="login-child-tab" class="flex-1 font-semibold py-2 text-gray-500">Soy Hijo</button>
            </div>
            <form id="login-form-parent" class="mt-6 space-y-4 w-full">
                <input type="email" id="login-email" placeholder="Correo electrónico" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--brand-color)]">
                <input type="password" id="login-password" placeholder="Contraseña" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--brand-color)]">
                <button type="submit" class="w-full bg-[var(--brand-color)] text-white font-bold py-3 rounded-lg hover:bg-[var(--brand-color-dark)] transition duration-300">Entrar</button>
            </form>
            <form id="login-form-child" class="mt-6 space-y-4 w-full hidden">
                <input type="text" id="login-parent-code" placeholder="Código del Padre" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--brand-color)]">
                <input type="text" id="login-child-name" placeholder="Tu nombre" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--brand-color)]">
                <input type="password" id="login-child-password" placeholder="Tu contraseña" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--brand-color)]">
                <button type="submit" class="w-full bg-[var(--brand-color)] text-white font-bold py-3 rounded-lg hover:bg-[var(--brand-color-dark)] transition duration-300">Entrar</button>
            </form>
            <p class="mt-4 text-sm text-gray-500 text-center"><a href="#" id="login-go-back" class="font-semibold text-[var(--brand-color)] hover:underline">Volver</a></p>
        </div>
        
        <!-- Pantalla de Verificación de Correo -->
        <div id="verify-email-screen" class="screen flex-1 flex-col items-center justify-center text-center p-6 md:p-8">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-blue-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
            </svg>
            <h2 class="text-2xl font-bold text-gray-800">Verifica tu Correo</h2>
            <p class="text-gray-500 mt-2">Hemos enviado un enlace de verificación a <strong id="verification-email-display"></strong>. Por favor, revisa tu bandeja de entrada y spam.</p>
            <button id="check-verification-button" class="mt-8 w-full bg-[var(--brand-color)] text-white font-bold py-3 rounded-lg">Listo, ya lo he verificado</button>
            <button id="resend-verification-email" class="mt-4 w-full bg-gray-200 text-gray-800 font-bold py-3 rounded-lg">Reenviar Correo</button>
            <p class="mt-6 text-sm text-gray-500"><a href="#" id="verification-logout-link" class="font-semibold text-gray-500 hover:underline">Volver al inicio</a></p>
        </div>

        <!-- Panel del Padre Mejorado -->
        <div id="parent-dashboard-screen" class="screen flex-1 flex-col h-full p-6 md:p-8">
            <div class="w-full flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Panel del Padre</h2>
                <div class="flex items-center gap-4">
                    <button id="notification-bell" class="relative text-gray-500 hover:text-[var(--brand-color)] transition">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
                        <span id="notification-badge" class="absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full hidden"></span>
                    </button>
                    <button id="logout-button-parent" title="Cerrar sesión" class="text-gray-500 hover:text-[var(--brand-color)] transition"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg></button>
                </div>
            </div>
            <div class="bg-[var(--brand-color-light)] p-4 rounded-lg text-center mb-6">
                <p class="text-sm text-indigo-800 font-medium">Comparte este código con tu hijo:</p>
                <p id="parent-code-display" class="text-2xl font-bold text-indigo-900 tracking-widest mt-2 cursor-pointer" title="Click para copiar"></p>
            </div>
            <h3 class="font-bold text-gray-700 mb-2 w-full">Hijos Vinculados:</h3>
            <div id="children-list" class="w-full space-y-3 flex-1 overflow-y-auto"></div>
        </div>

        <!-- Panel del Hijo Mejorado -->
        <div id="child-dashboard-screen" class="screen flex-1 flex-col h-full">
             <div class="p-6 md:p-8 pb-4 flex-shrink-0">
                <div class="w-full flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">Hola, <span id="child-name-display"></span>!</h2>
                    <button id="logout-button-child" title="Cerrar sesión" class="text-gray-500 hover:text-[var(--brand-color)] transition"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg></button>
                </div>
                <div id="child-block-message" class="hidden text-center text-sm text-red-600 my-4 p-3 bg-red-100 rounded-lg"></div>
                <div id="parent-chat-container" class="w-full"></div>
            </div>
            <div class="flex flex-col flex-1 overflow-hidden px-6 md:px-8 pb-6">
                <div id="child-controls" class="w-full flex-shrink-0">
                    <div class="grid grid-cols-2 gap-4 w-full my-6">
                        <button id="show-qr-button" class="bg-green-500 text-white font-bold py-3 rounded-xl hover:bg-green-600 transition shadow-sm flex items-center justify-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>Mi QR</button>
                        <button id="scan-qr-button" class="bg-blue-500 text-white font-bold py-3 rounded-xl hover:bg-blue-600 transition shadow-sm flex items-center justify-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7V5a2 2 0 0 1 2-2h2"></path><path d="M17 3h2a2 2 0 0 1 2 2v2"></path><path d="M21 17v2a2 2 0 0 1-2 2h-2"></path><path d="M7 21H5a2 2 0 0 1-2-2v-2"></path></svg>Escanear</button>
                    </div>
                    <div id="add-friends-disabled-msg" class="hidden text-center text-sm text-gray-500 my-2 p-3 bg-gray-100 rounded-lg">Tu padre ha desactivado la opción de añadir amigos.</div>
                    <h3 class="font-bold text-gray-700 mb-2 w-full flex-shrink-0">Amigos:</h3>
                </div>
                <div id="friends-list" class="w-full space-y-2 flex-1 overflow-y-auto"></div>
            </div>
        </div>
        
        <!-- Vista de Chat (oculta por defecto) -->
        <div id="chat-screen" class="screen flex-1 w-full h-full flex-col">
            <div class="w-full flex items-center p-6 md:p-8 pb-4 border-b flex-shrink-0">
                <button id="back-to-dashboard" class="mr-3 text-gray-500 hover:text-[var(--brand-color)]">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
                </button>
                <div>
                    <h2 class="text-lg font-bold text-gray-800" id="chat-with-name"></h2>
                    <div id="chat-status" class="text-xs text-gray-500 h-4"></div>
                </div>
            </div>
            <div id="messages-container" class="flex-1 w-full px-4 pt-4 overflow-y-auto flex flex-col-reverse">
                <div id="messages-list" class="flex flex-col gap-1"></div>
            </div>
            <div class="p-6 md:p-8 pt-4 flex-shrink-0">
                <form id="message-form" class="w-full flex gap-2 items-center">
                    <input type="text" id="message-input" placeholder="Escribe un mensaje..." class="flex-1 px-4 py-2 border border-gray-300 bg-gray-100 rounded-full focus:outline-none focus:ring-2 focus:ring-[var(--brand-color)]" autocomplete="off">
                    <button type="submit" id="send-btn" class="bg-[var(--brand-color)] text-white rounded-full p-3 flex items-center justify-center hover:bg-[var(--brand-color-dark)] transition shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>
                    </button>
                </form>
            </div>
        </div>

        <!-- Modales -->
        <div id="qr-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50">
            <div class="bg-white p-8 rounded-2xl shadow-xl text-center flex flex-col items-center glass-modal">
                <h3 class="text-xl font-bold mb-4">Muestra este QR a tu amigo</h3>
                <div id="qrcode-container" class="p-2 border rounded-lg w-[208px] h-[208px]"></div>
                <p class="text-sm text-gray-500 mt-2">Este código cambia muy rápido por seguridad.</p>
                <button id="close-qr-modal" class="mt-6 bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">Cerrar</button>
            </div>
        </div>
        <div id="scan-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50">
             <div class="bg-white p-6 rounded-2xl shadow-xl text-center w-11/12 max-w-lg glass-modal">
                <h3 class="text-xl font-bold mb-2">Escanea el QR de tu amigo</h3>
                <div id="qr-reader" class="w-full border rounded-lg overflow-hidden"></div>
                <button id="close-scan-modal" class="mt-6 bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">Cancelar</button>
            </div>
        </div>
         <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50">
             <div class="bg-white p-6 rounded-2xl shadow-xl text-center w-11/12 max-w-sm glass-modal">
                <h3 id="confirm-title" class="text-lg font-bold mb-2">¿Estás seguro?</h3>
                <p id="confirm-message" class="text-gray-600 mb-6">Esta acción no se puede deshacer.</p>
                <div class="flex gap-4">
                    <button id="confirm-cancel" class="flex-1 bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Cancelar</button>
                    <button id="confirm-accept" class="flex-1 bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600">Aceptar</button>
                </div>
            </div>
        </div>
        <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50">
            <div class="bg-white p-6 rounded-2xl shadow-xl w-11/12 max-w-sm max-h-[90vh] overflow-y-auto glass-modal">
                <h3 class="text-lg font-bold mb-4">Ajustes para <span id="settings-child-name"></span></h3>
                <div class="space-y-4">
                    <div class="flex items-center justify-between bg-white/50 p-3 rounded-lg">
                        <label for="can-add-friends-toggle" class="font-medium text-gray-700">Permitir añadir amigos</label>
                        <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" id="can-add-friends-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                            <label for="can-add-friends-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                    </div>
                    <div class="bg-white/50 p-3 rounded-lg">
                        <div class="flex items-center justify-between">
                             <label for="time-limit-toggle" class="font-medium text-gray-700">Límite de horario</label>
                            <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" id="time-limit-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                <label for="time-limit-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                            </div>
                        </div>
                        <div id="time-inputs-container" class="hidden space-y-2 pt-4 border-t mt-4">
                            <div class="flex items-center justify-between gap-4">
                                <label for="start-time" class="text-sm font-medium text-gray-600">Desde:</label>
                                <input type="time" id="start-time" class="w-auto border-gray-300 rounded-md shadow-sm text-sm">
                            </div>
                            <div class="flex items-center justify-between gap-4">
                                <label for="end-time" class="text-sm font-medium text-gray-600">Hasta:</label>
                                <input type="time" id="end-time" class="w-auto border-gray-300 rounded-md shadow-sm text-sm">
                            </div>
                        </div>
                    </div>
                    <div class="bg-white/50 p-3 rounded-lg">
                        <div class="flex items-center justify-between">
                            <label for="session-time-toggle" class="font-medium text-gray-700">Tiempo de sesión</label>
                            <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" id="session-time-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                <label for="session-time-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                            </div>
                        </div>
                        <div id="session-time-container" class="hidden flex items-center justify-between gap-4 pt-4 border-t mt-4">
                            <label for="session-duration" class="text-sm font-medium text-gray-600">Duración:</label>
                            <input type="number" id="session-duration" value="30" min="1" class="w-20 border-gray-300 rounded-md shadow-sm text-sm">
                            <select id="session-unit" class="border-gray-300 rounded-md shadow-sm text-sm">
                                <option value="minutes">minutos</option>
                                <option value="hours">horas</option>
                            </select>
                        </div>
                    </div>
                     <div class="bg-white/50 p-3 rounded-lg">
                        <label for="text-filter-level" class="font-medium text-gray-700">Filtro de texto</label>
                        <select id="text-filter-level" class="mt-2 w-full border-gray-300 rounded-md shadow-sm">
                            <option value="low">Bajo (Odio)</option>
                            <option value="medium" selected>Medio (Palabrotas)</option>
                            <option value="high">Extremo (Todo)</option>
                        </select>
                    </div>
                </div>
                <div class="flex gap-4 mt-6">
                    <button id="settings-cancel" class="flex-1 bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Cancelar</button>
                    <button id="settings-save" class="flex-1 bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600">Guardar</button>
                </div>
            </div>
        </div>
        <div id="notifications-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50">
             <div class="bg-white p-6 rounded-2xl shadow-xl w-11/12 max-w-sm max-h-[90vh] overflow-y-auto glass-modal flex flex-col">
                <h3 class="text-lg font-bold mb-4">Notificaciones</h3>
                <div id="notifications-list" class="flex-1 space-y-2 overflow-y-auto"></div>
                <button id="close-notifications-modal" class="mt-6 bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">Cerrar</button>
            </div>
        </div>
    </div>
    
    <div id="notification" class="fixed bottom-5 right-5 bg-gray-900 text-white py-2 px-5 rounded-full shadow-lg opacity-0 transform translate-y-3 transition-all duration-300 pointer-events-none z-50">
        <p id="notification-message"></p>
    </div>
    <div id="log-container" class="fixed bottom-0 left-0 right-0 h-48 bg-black bg-opacity-75 text-white text-xs font-mono p-2 overflow-y-scroll hidden z-50"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendEmailVerification } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs, addDoc, onSnapshot, orderBy, serverTimestamp, deleteDoc, limit, updateDoc, writeBatch, FieldValue, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyC1XbhA7TTz7gn-3_SFJ53p7DPfq36eRdg",
            authDomain: "safechat-224e2.firebaseapp.com",
            projectId: "safechat-224e2",
            storageBucket: "safechat-224e2.firebasestorage.app",
            messagingSenderId: "390500687585",
            appId: "1:390500687585:web:36fc0ce72b58e02351e1a0"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null, currentUserData = null, html5QrCode = null;
        let unsubscribeUserStatus = () => {}, unsubscribeFriends = () => {}, unsubscribeCurrentChat = () => {}, unsubscribeTyping = () => {}, unsubscribeNotifications = () => {};
        let friendStatusUnsubscribers = {};
        let childFriendUnsubscribers = {};
        let timeLimitInterval;
        let usageInterval;
        let timeOffset = 0;
        let childChartInstances = {};

        const logContainer = document.getElementById('log-container');
        function logToScreen(message) {
            if (logContainer) {
                const time = new Date().toLocaleTimeString();
                const p = document.createElement('p');
                p.textContent = `[${time}] ${message}`;
                logContainer.prepend(p);
            }
            console.log(message);
        }

        let clickCount = 0;
        let clickTimer = null;
        document.querySelector('.app-container').addEventListener('click', () => {
            clickCount++;
            if (clickCount === 1) {
                clickTimer = setTimeout(() => { clickCount = 0; }, 500);
            } else if (clickCount === 5) {
                clearTimeout(clickTimer);
                clickCount = 0;
                logContainer.classList.toggle('hidden');
            }
        });

        const showScreen = (screenId) => {
            logToScreen(`Showing screen: ${screenId}`);
            document.querySelectorAll('.screen').forEach(s => {
                s.classList.remove('active-screen');
            });
            document.getElementById(screenId).classList.add('active-screen');
        };

        const setVh = () => {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        };
        window.addEventListener('resize', setVh);
        window.addEventListener('load', setVh);
        setVh();
        
        function showNotification(message) {
            const el = document.getElementById('notification'), msgEl = document.getElementById('notification-message');
            msgEl.textContent = message;
            el.classList.remove('opacity-0', 'translate-y-3');
            setTimeout(() => el.classList.add('opacity-0', 'translate-y-3'), 2500);
        }

        function showConfirmation(title, message, onAccept) {
            const modal = document.getElementById('confirm-modal');
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-message').textContent = message;
            modal.classList.replace('hidden', 'flex');
            const acceptBtn = document.getElementById('confirm-accept');
            const cancelBtn = document.getElementById('confirm-cancel');
            const close = () => modal.classList.replace('flex', 'hidden');
            acceptBtn.onclick = () => { close(); onAccept(); };
            cancelBtn.onclick = close;
        }

        function resetWelcomeScreen() {
            document.getElementById('parent-register-container').classList.add('hidden');
            document.getElementById('child-register-container').classList.add('hidden');
            document.getElementById('parent-onboarding-container').classList.add('hidden');
            document.getElementById('welcome-main').classList.remove('hidden');
        }

        const updateUserOnlineStatus = async (isOnline) => {
            if (!auth.currentUser) return;
            try {
                await updateDoc(doc(db, "users", auth.currentUser.uid), { isOnline, lastSeen: serverTimestamp() });
            } catch (e) { console.error("Error updating status:", e) }
        };
        window.addEventListener('beforeunload', () => updateUserOnlineStatus(false));

        async function syncTime() {
            try {
                const timeSyncRef = doc(db, 'meta/timeSync');
                await setDoc(timeSyncRef, { time: serverTimestamp() });
                const docSnap = await getDoc(timeSyncRef);
                const serverNow = docSnap.data().time.toMillis();
                timeOffset = serverNow - Date.now();
            } catch(e) { console.error("Error al sincronizar la hora:", e); timeOffset = 0; }
        }

        onAuthStateChanged(auth, async (user) => {
            logToScreen('onAuthStateChanged triggered.');
            [unsubscribeUserStatus, unsubscribeFriends, unsubscribeCurrentChat, unsubscribeTyping, unsubscribeNotifications, ...Object.values(friendStatusUnsubscribers), ...Object.values(childFriendUnsubscribers)].forEach(unsub => unsub());
            friendStatusUnsubscribers = {};
            childFriendUnsubscribers = {};
            clearInterval(timeLimitInterval);
            clearInterval(usageInterval);
            resetWelcomeScreen();

            if (user) {
                logToScreen('User detected: ' + user.uid);
                await user.reload(); 
                await syncTime();
                const userDocRef = doc(db, "users", user.uid);
                
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists()) {
                    currentUser = auth.currentUser;
                    currentUserData = { id: user.uid, ...userDocSnap.data() };
                    logToScreen('User doc exists. Role: ' + currentUserData.role);

                    if (currentUserData.role === 'parent' && !currentUser.emailVerified) {
                        logToScreen('Parent email not verified. Showing verification screen.');
                        document.getElementById('verification-email-display').textContent = currentUser.email;
                        showScreen('verify-email-screen');
                        return;
                    }
                    
                    await updateUserOnlineStatus(true);
                    
                    unsubscribeUserStatus = onSnapshot(userDocRef, async (snap) => {
                        if (!snap.exists()) { await signOut(auth); return; }
                        currentUserData = { id: snap.id, ...snap.data() };
                        if (currentUserData.role === 'child') {
                            updateChildControls(currentUserData.settings);
                        }
                    });

                    if (currentUserData.role === 'parent') {
                        logToScreen('Setting up parent dashboard...');
                        setupParentDashboard();
                        showScreen('parent-dashboard-screen');
                    } else if (currentUserData.role === 'child') {
                        logToScreen('Setting up child dashboard...');
                        await setupChildDashboard();
                    }
                } else { 
                    logToScreen('User doc does NOT exist for UID: ' + user.uid);
                    showNotification("No se pudo encontrar tu perfil de usuario. Por favor, contacta a soporte.");
                    await signOut(auth);
                }
            } else {
                logToScreen('No user detected.');
                currentUser = null;
                currentUserData = null;
                showScreen('welcome-screen');
            }
        });
        
        document.getElementById('parent-register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('parent-name').value, email = document.getElementById('parent-email').value, password = document.getElementById('parent-password').value;
            try {
                const cred = await createUserWithEmailAndPassword(auth, email, password);
                const parentCode = `SAFE${Math.random().toString(36).substring(2, 8).toUpperCase()}`;
                await setDoc(doc(db, "users", cred.user.uid), { name, email, role: 'parent', parentCode });
                await sendEmailVerification(cred.user);
                showNotification('Registro exitoso. Revisa tu correo para verificar.');
                document.getElementById('verification-email-display').textContent = email;
                showScreen('verify-email-screen');
            } catch (error) { showNotification(`Error: ${error.message}`); }
        });

        document.getElementById('child-register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const parentCode = document.getElementById('parent-code').value;
            const name = document.getElementById('child-name').value;
            const password = document.getElementById('child-password').value;
            
            try {
                const parentQuery = query(collection(db, "users"), where("parentCode", "==", parentCode), limit(1));
                const parentSnap = await getDocs(parentQuery);
                if (parentSnap.empty) { throw new Error("Código del padre no válido."); }
                const parentId = parentSnap.docs[0].id;

                const childQuery = query(collection(db, "users"), where("parentId", "==", parentId), where("name_lowercase", "==", name.toLowerCase()));
                const childSnap = await getDocs(childQuery);
                if (!childSnap.empty) { throw new Error("Ya existe un usuario con este nombre. Intenta iniciar sesión."); }

                const email = `${name.replace(/\s+/g, '').toLowerCase()}.${Date.now()}@safechat.local`;
                const cred = await createUserWithEmailAndPassword(auth, email, password);
                await setDoc(doc(db, "users", cred.user.uid), {
                    name, email, role: 'child', parentId, name_lowercase: name.toLowerCase(),
                    settings: { 
                        canAddFriends: true, 
                        timeLimits: { enabled: false, startTime: '08:00', endTime: '22:00' },
                        sessionTime: { enabled: false, duration: 30, unit: 'minutes'},
                        filters: { textLevel: 'medium' }
                    }
                });
            } catch (error) { showNotification(`Error: ${error.message}`); }
        });

        document.getElementById('login-form-parent').addEventListener('submit', (e) => {
            e.preventDefault();
            logToScreen('Attempting parent login...');
            signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-password').value).catch(err => {
                logToScreen('Parent login error: ' + err.message);
                showNotification(`Error: ${err.message}`);
            });
        });

        document.getElementById('login-form-child').addEventListener('submit', async (e) => {
            e.preventDefault();
            logToScreen('Attempting child login...');
            const parentCode = document.getElementById('login-parent-code').value, childName = document.getElementById('login-child-name').value, password = document.getElementById('login-child-password').value;
            try {
                const pQuery = query(collection(db, "users"), where("parentCode", "==", parentCode), limit(1));
                const pSnap = await getDocs(pQuery);
                if (pSnap.empty) throw new Error("Código del padre inválido.");
                const cQuery = query(collection(db, "users"), where("parentId", "==", pSnap.docs[0].id), where("name_lowercase", "==", childName.toLowerCase()), limit(1));
                const cSnap = await getDocs(cQuery);
                if (cSnap.empty) throw new Error("Datos de hijo incorrectos.");
                await signInWithEmailAndPassword(auth, cSnap.docs[0].data().email, password);
            } catch (error) { 
                logToScreen('Child login error: ' + error.message);
                showNotification(`Error: ${error.message}`); 
            }
        });
        
        ['logout-button-parent', 'logout-button-child', 'verification-logout-link'].forEach(id => {
            document.getElementById(id).addEventListener('click', async (e) => {
                e.preventDefault();
                await updateUserOnlineStatus(false);
                await signOut(auth);
            });
        });
        
        document.getElementById('resend-verification-email').addEventListener('click', async () => {
            if (currentUser) {
                try {
                    await sendEmailVerification(currentUser);
                    showNotification('Correo de verificación reenviado.');
                } catch (error) { showNotification(`Error: ${error.message}`); }
            }
        });

        document.getElementById('check-verification-button').addEventListener('click', async () => {
            if (auth.currentUser) {
                await auth.currentUser.reload();
                if (auth.currentUser.emailVerified) {
                    showNotification("¡Correo verificado con éxito!");
                    onAuthStateChanged(auth, () => {}); // Force re-trigger
                } else {
                    showNotification("Aún no has verificado tu correo. Revisa tu bandeja de entrada.");
                }
            }
        });

        // --- PANELES ---
        function setupParentDashboard() {
            const codeDisplay = document.getElementById('parent-code-display');
            codeDisplay.textContent = currentUserData.parentCode;
            codeDisplay.onclick = () => {
                navigator.clipboard.writeText(currentUserData.parentCode);
                showNotification('¡Código copiado!');
            };
            
            setupNotifications();

            const q = query(collection(db, "users"), where("parentId", "==", currentUser.uid));
            onSnapshot(q, (snapshot) => {
                Object.values(childFriendUnsubscribers).forEach(unsub => unsub());
                childFriendUnsubscribers = {};
                document.getElementById('children-list').innerHTML = snapshot.empty ? '<p class="text-gray-400">Aún no hay hijos vinculados.</p>' : '';
                snapshot.forEach(doc => {
                    const child = { id: doc.id, ...doc.data() };
                    const el = document.createElement('div');
                    el.className = 'glass-card p-3 rounded-lg';
                    el.innerHTML = `
                        <div class="flex justify-between items-center">
                            <p class="font-semibold text-gray-800">${child.name}</p>
                            <div class="flex items-center gap-2">
                                <button id="chat-child-${child.id}" title="Chatear con ${child.name}" class="text-gray-400 hover:text-green-500 p-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                                </button>
                                <button id="settings-child-${child.id}" title="Ajustes" class="text-gray-400 hover:text-blue-500 p-1"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></button>
                                <button id="unlink-child-${child.id}" title="Desvincular hijo" class="text-gray-400 hover:text-red-500 p-1"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="18" y1="8" x2="23" y2="13"></line><line x1="23" y1="8" x2="18" y2="13"></line></svg></button>
                            </div>
                        </div>
                        <div id="stats-container-${child.id}" class="mt-4">
                             <div class="text-center p-4 bg-white/30 rounded-lg">
                                <p class="text-sm font-medium text-gray-500">Tiempo de hoy</p>
                                <p id="today-usage-${child.id}" class="text-3xl font-bold text-gray-800">0m</p>
                            </div>
                            <div class="mt-4"><canvas id="usage-chart-${child.id}"></canvas></div>
                        </div>`;
                    document.getElementById('children-list').appendChild(el);
                    el.querySelector(`#chat-child-${child.id}`).onclick = () => openChat(child.id, child.name);
                    el.querySelector(`#settings-child-${child.id}`).onclick = () => openSettingsModal(child);
                    el.querySelector(`#unlink-child-${child.id}`).onclick = () => {
                        showConfirmation('Desvincular Hijo', `¿Seguro que quieres desvincular a ${child.name}? Podrá volver a unirse con tu código.`, () => {
                            updateDoc(doc(db, "users", child.id), { parentId: null });
                        });
                    };
                    displayChildStats(child.id);
                });
            });
        }
        
        async function displayChildStats(childId) {
            const today = new Date();
            let weeklyData = Array(7).fill(0);
            let labels = [];

            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const dateString = date.toISOString().split('T')[0]; // YYYY-MM-DD
                labels.push(date.toLocaleDateString('es-ES', { weekday: 'short' }));

                const usageDoc = await getDoc(doc(db, 'users', childId, 'usage', dateString));
                if (usageDoc.exists()) {
                    weeklyData[6-i] = usageDoc.data().totalMinutes || 0;
                }
            }

            const todayUsageEl = document.getElementById(`today-usage-${childId}`);
            const todayMinutes = weeklyData[6];
            if (todayMinutes >= 60) {
                todayUsageEl.textContent = `${Math.floor(todayMinutes/60)}h ${todayMinutes % 60}m`;
            } else {
                todayUsageEl.textContent = `${todayMinutes}m`;
            }
            
            const ctx = document.getElementById(`usage-chart-${childId}`).getContext('2d');
            if (childChartInstances[childId]) {
                childChartInstances[childId].destroy();
            }
            childChartInstances[childId] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Minutos de uso',
                        data: weeklyData,
                        backgroundColor: 'rgba(99, 102, 241, 0.6)',
                        borderColor: 'rgba(99, 102, 241, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: { beginAtZero: true }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }


        async function setupChildDashboard() {
            logToScreen('setupChildDashboard started.');
            if (!currentUserData.parentId) {
                logToScreen('Child is unlinked (no parentId). Signing out.');
                showNotification("Tu cuenta ha sido desvinculada. Por favor, regístrate de nuevo.");
                await signOut(auth);
                return;
            }

            const parentDoc = await getDoc(doc(db, "users", currentUserData.parentId));
            if (!parentDoc.exists()) {
                logToScreen('Parent document not found for parentId: ' + currentUserData.parentId + '. Signing out.');
                showNotification("No se pudo encontrar la cuenta de tu padre. Tu cuenta puede estar desvinculada.");
                await signOut(auth);
                return;
            }
            const parentData = parentDoc.data();
            logToScreen('Parent found. Displaying dashboard.');

            document.getElementById('child-name-display').textContent = currentUserData.name;
            const parentChatContainer = document.getElementById('parent-chat-container');
            parentChatContainer.innerHTML = `
                <h3 class="font-bold text-gray-700 mb-2 w-full flex-shrink-0">Chat Seguro</h3>
                <div id="parent-chat-btn" class="w-full text-left bg-yellow-100 p-3 rounded-xl hover:bg-yellow-200 transition flex items-center justify-between cursor-pointer">
                    <div class="flex items-center gap-3">
                        <div class="relative">
                            <div class="w-10 h-10 rounded-full bg-yellow-200 flex items-center justify-center font-bold text-yellow-600">P</div>
                        </div>
                        <span class="font-semibold text-gray-800">${parentData.name} (Padre/Madre)</span>
                    </div>
                </div>`;
            document.getElementById('parent-chat-btn').onclick = () => openChat(currentUserData.parentId, parentData.name);
            
            clearInterval(timeLimitInterval);
            timeLimitInterval = setInterval(() => checkChildLockState(currentUserData.settings), 30000);
            
            clearInterval(usageInterval);
            usageInterval = setInterval(() => updateUsage(currentUser.uid), 60000); // Cada minuto
            
            if(checkChildLockState(currentUserData.settings)){
                 return;
            }
            showScreen('child-dashboard-screen');
            
            const q = query(collection(db, "friendships"), where("users", "array-contains", currentUser.uid));
            unsubscribeFriends = onSnapshot(q, (snapshot) => {
                document.getElementById('friends-list').innerHTML = snapshot.empty ? '<p class="text-gray-400 text-center w-full">¡Añade amigos escaneando su QR!</p>' : '';
                Object.values(friendStatusUnsubscribers).forEach(unsub => unsub());
                friendStatusUnsubscribers = {};

                snapshot.forEach(async (docSnap) => {
                    const friendId = docSnap.data().users.find(id => id !== currentUser.uid);
                    const friendDocRef = doc(db, "users", friendId);
                    const friendDoc = await getDoc(friendDocRef);
                    if (friendDoc.exists()) {
                        const friendData = friendDoc.data();
                        const friendEl = document.createElement('div');
                        friendEl.id = `friend-${friendId}`;
                        friendEl.className = 'w-full text-left glass-card p-3 rounded-xl hover:bg-white/70 transition flex items-center justify-between cursor-pointer';
                        friendEl.innerHTML = `
                            <div class="flex items-center gap-3">
                                <div class="relative">
                                    <div class="w-10 h-10 rounded-full bg-indigo-200 flex items-center justify-center font-bold text-indigo-600">${friendData.name.charAt(0)}</div>
                                    <div id="status-${friendId}" class="absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-white ${friendData.isOnline ? 'bg-green-500' : 'bg-gray-400'}"></div>
                                </div>
                                <span class="font-semibold text-gray-800">${friendData.name}</span>
                            </div>
                            <button class="delete-friend-btn text-gray-400 hover:text-red-500 p-1 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></button>
                        `;
                        friendEl.querySelector('.delete-friend-btn').addEventListener('click', (e) => {
                             e.stopPropagation();
                             showConfirmation('Eliminar Amigo', `¿Seguro que quieres eliminar a ${friendData.name}?`, () => {
                                 deleteDoc(doc(db, "friendships", docSnap.id));
                             });
                        });
                        friendEl.addEventListener('click', () => openChat(friendId, friendData.name));
                        document.getElementById('friends-list').appendChild(friendEl);

                        friendStatusUnsubscribers[friendId] = onSnapshot(friendDocRef, (snap) => {
                            const statusEl = document.getElementById(`status-${friendId}`);
                            if (statusEl) statusEl.className = `absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-white ${snap.data().isOnline ? 'bg-green-500' : 'bg-gray-400'}`;
                        });
                    }
                });
            });
        }
        
        // --- LÓGICA DE QR (Amistad) ---
        let qrTimerInterval, qrTokenCleanupTimeout;
        const startQrModal = async () => {
            document.getElementById('qr-modal').classList.replace('hidden', 'flex');
            const token = `QR_${currentUser.uid}_${Date.now()}`;
            await setDoc(doc(db, "qr_tokens", currentUser.uid), { token, expires: new Date(Date.now() + 30000) });
            qrTokenCleanupTimeout = setTimeout(() => deleteDoc(doc(db, "qr_tokens", currentUser.uid)), 31000);
            const generateVisual = () => {
                document.getElementById('qrcode-container').innerHTML = '';
                new QRCode(document.getElementById('qrcode-container'), { text: JSON.stringify({ userId: currentUser.uid, token, nonce: Date.now() }), width: 192, height: 192 });
            };
            generateVisual();
            qrTimerInterval = setInterval(generateVisual, 500);
        };
        const closeQrModal = () => {
            document.getElementById('qr-modal').classList.replace('flex', 'hidden');
            clearInterval(qrTimerInterval);
            clearTimeout(qrTokenCleanupTimeout);
            deleteDoc(doc(db, "qr_tokens", currentUser.uid));
        };
        
        const startScanModal = () => {
            document.getElementById('scan-modal').classList.replace('hidden', 'flex');
            html5QrCode = new Html5Qrcode("qr-reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, async (text) => {
                stopScanner();
                showNotification('Procesando QR...');
                try {
                    const data = JSON.parse(text);
                    if (!data.userId || !data.token) throw new Error("QR no válido.");
                    if (data.userId === currentUser.uid) throw new Error("No puedes agregarte a ti mismo.");
                    const friendshipId = [currentUser.uid, data.userId].sort().join('_');
                    if ((await getDoc(doc(db, "friendships", friendshipId))).exists()) throw new Error("¡Ya sois amigos!");
                    const tokenDoc = await getDoc(doc(db, "qr_tokens", data.userId));
                    if (!tokenDoc.exists() || tokenDoc.data().expires.toDate() < new Date()) throw new Error("El código QR ha expirado.");

                    const batch = writeBatch(db);
                    const friendshipRef = doc(db, "friendships", friendshipId);
                    batch.set(friendshipRef, { users: [currentUser.uid, data.userId].sort() });
                    const tokenRef = doc(db, "qr_tokens", data.userId);
                    batch.delete(tokenRef);
                    await batch.commit();
                    
                    showNotification("¡Amigo agregado con éxito!");
                } catch (error) { showNotification(error.message.includes("JSON") ? "QR no válido." : `Error: ${error.message}`); }
            }, () => {});
        };
        const stopScanner = () => {
            if (html5QrCode && html5QrCode.isScanning) html5QrCode.stop().catch(console.error);
            document.getElementById('scan-modal').classList.replace('flex', 'hidden');
        };
        
        document.getElementById('show-qr-button').onclick = startQrModal;
        document.getElementById('close-qr-modal').onclick = closeQrModal;
        document.getElementById('scan-qr-button').onclick = startScanModal;
        document.getElementById('close-scan-modal').onclick = stopScanner;

        // --- LÓGICA DE CHAT ---
        let currentChatId = null, typingTimeout = null;
        
        function openChat(friendId, friendName, readOnly = false, viewerId = currentUser.uid) {
            showScreen('chat-screen');
            currentChatId = [viewerId, friendId].sort().join('_');
            document.getElementById('chat-with-name').textContent = friendName;
            document.getElementById('message-form').style.display = readOnly ? 'none' : 'flex';
            
            const messagesList = document.getElementById('messages-list');
            messagesList.innerHTML = '';
            
            const q = query(collection(db, "chats", currentChatId, "messages"), orderBy("timestamp", "desc"), limit(50));
            unsubscribeCurrentChat = onSnapshot(q, (snapshot) => {
                messagesList.innerHTML = '';
                snapshot.docs.reverse().forEach(msgDoc => {
                    const message = msgDoc.data();
                    const el = document.createElement('div');
                    let content = `<span>${message.text || ''}</span>`;
                    
                    el.className = `message ${message.senderId === viewerId ? 'sent' : 'received'}`;
                    const time = message.timestamp ? message.timestamp.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
                    el.innerHTML = `${content}<span class="timestamp">${time}</span>`;
                    messagesList.appendChild(el);
                });
                 document.getElementById('messages-container').scrollTop = document.getElementById('messages-container').scrollHeight;
            });

            if (!readOnly) {
                const typingRef = doc(db, "typing_status", currentChatId);
                unsubscribeTyping = onSnapshot(typingRef, (snap) => {
                    const statusEl = document.getElementById('chat-status');
                    if (snap.exists() && snap.data()[friendId]) {
                        statusEl.innerHTML = `<div class="typing-indicator"><span></span><span></span><span></span></div>`;
                    } else {
                        statusEl.innerHTML = '';
                    }
                });
            }
        }
        
        document.getElementById('message-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = document.getElementById('message-input');
            let messageText = input.value.trim();
            if (messageText && currentChatId) {
                const filterLevel = currentUserData.settings?.filters?.textLevel || 'medium';
                const matchedWord = filterMessage(messageText, filterLevel);
                if (matchedWord) {
                    showNotification("Tu mensaje contiene palabras no permitidas.");
                    await createInfractionNotification(messageText, matchedWord);
                    return;
                }
                await addDoc(collection(db, "chats", currentChatId, "messages"), { text: messageText, senderId: currentUser.uid, timestamp: serverTimestamp(), type: 'text' });
                input.value = '';
            }
        });

        document.getElementById('message-input').addEventListener('input', () => {
            if (!currentChatId) return;
            const typingRef = doc(db, "typing_status", currentChatId);
            clearTimeout(typingTimeout);
            updateDoc(typingRef, { [currentUser.uid]: true }).catch(() => setDoc(typingRef, { [currentUser.uid]: true }));
            typingTimeout = setTimeout(() => updateDoc(typingRef, { [currentUser.uid]: false }), 2000);
        });

        document.getElementById('back-to-dashboard').addEventListener('click', () => {
             unsubscribeCurrentChat();
             unsubscribeTyping();
             if (currentUserData.role === 'parent') {
                showScreen('parent-dashboard-screen');
             } else {
                showScreen('child-dashboard-screen');
             }
        });

        // --- NAVEGACIÓN GENERAL ---
        document.getElementById('show-login').onclick = () => showScreen('login-screen');

        document.getElementById('show-parent-onboarding').addEventListener('click', () => {
            document.getElementById('welcome-main').classList.add('hidden');
            document.getElementById('parent-onboarding-container').classList.remove('hidden');
        });

        document.getElementById('show-child-register').addEventListener('click', () => {
            document.getElementById('welcome-main').classList.add('hidden');
            document.getElementById('child-register-container').classList.remove('hidden');
        });

        document.querySelectorAll('.go-back').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                resetWelcomeScreen();
            });
        });
        
        document.getElementById('login-go-back').addEventListener('click', (e) => {
            e.preventDefault();
            showScreen('welcome-screen');
        });
        
        const loginParentTab = document.getElementById('login-parent-tab'), loginChildTab = document.getElementById('login-child-tab');
        const loginFormParent = document.getElementById('login-form-parent'), loginFormChild = document.getElementById('login-form-child');
        loginParentTab.onclick = () => {
            loginParentTab.classList.add('border-[var(--brand-color)]', 'text-[var(--brand-color)]');
            loginChildTab.classList.remove('border-[var(--brand-color)]', 'text-[var(--brand-color)]');
            loginFormParent.classList.remove('hidden');
            loginFormChild.classList.add('hidden');
        };
        loginChildTab.onclick = () => {
            loginChildTab.classList.add('border-[var(--brand-color)]', 'text-[var(--brand-color)]');
            loginParentTab.classList.remove('border-[var(--brand-color)]', 'text-[var(--brand-color)]');
            loginFormChild.classList.remove('hidden');
            loginFormParent.classList.add('hidden');
        };

        const onboardingSlides = document.querySelectorAll('.onboarding-slide');
        const nextOnboardingBtn = document.getElementById('next-onboarding-slide');
        let currentOnboardingSlide = 0;

        function updateOnboardingView() {
            onboardingSlides.forEach((slide, index) => {
                slide.classList.toggle('hidden', index !== currentOnboardingSlide);
            });
            if (currentOnboardingSlide === onboardingSlides.length - 1) {
                nextOnboardingBtn.textContent = 'Empezar';
            } else {
                nextOnboardingBtn.textContent = 'Siguiente';
            }
        }
        
        nextOnboardingBtn.addEventListener('click', () => {
            if (currentOnboardingSlide < onboardingSlides.length - 1) {
                currentOnboardingSlide++;
                updateOnboardingView();
            } else {
                document.getElementById('parent-onboarding-container').classList.add('hidden');
                document.getElementById('parent-register-container').classList.remove('hidden');
            }
        });

        document.getElementById('onboarding-go-back').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('parent-onboarding-container').classList.add('hidden');
            document.getElementById('welcome-main').classList.remove('hidden');
        });

        // --- LÓGICA DE AJUSTES (PADRE) ---
        const settingsModal = document.getElementById('settings-modal');
        const settingsChildName = document.getElementById('settings-child-name');
        const canAddFriendsToggle = document.getElementById('can-add-friends-toggle');
        const timeLimitToggle = document.getElementById('time-limit-toggle');
        const timeInputsContainer = document.getElementById('time-inputs-container');
        const startTimeInput = document.getElementById('start-time');
        const endTimeInput = document.getElementById('end-time');
        const sessionTimeToggle = document.getElementById('session-time-toggle');
        const sessionTimeContainer = document.getElementById('session-time-container');
        const sessionDurationInput = document.getElementById('session-duration');
        const sessionUnitSelect = document.getElementById('session-unit');
        const textFilterSelect = document.getElementById('text-filter-level');
        let currentEditingChild = null;

        function openSettingsModal(child) {
            currentEditingChild = child;
            settingsChildName.textContent = child.name;
            const defaultSettings = { 
                canAddFriends: true, 
                timeLimits: { enabled: false, startTime: '08:00', endTime: '22:00' },
                sessionTime: { enabled: false, duration: 30, unit: 'minutes'},
                filters: { textLevel: 'medium' }
            };

            const settings = {
                ...defaultSettings,
                ...child.settings,
                timeLimits: { ...defaultSettings.timeLimits, ...child.settings?.timeLimits },
                sessionTime: { ...defaultSettings.sessionTime, ...child.settings?.sessionTime },
                filters: { ...defaultSettings.filters, ...child.settings?.filters }
            };
            
            canAddFriendsToggle.checked = settings.canAddFriends;
            timeLimitToggle.checked = settings.timeLimits.enabled;
            startTimeInput.value = settings.timeLimits.startTime;
            endTimeInput.value = settings.timeLimits.endTime;
            sessionTimeToggle.checked = settings.sessionTime.enabled;
            sessionDurationInput.value = settings.sessionTime.duration;
            sessionUnitSelect.value = settings.sessionTime.unit;
            textFilterSelect.value = settings.filters.textLevel;
            
            timeInputsContainer.style.display = settings.timeLimits.enabled ? 'block' : 'none';
            sessionTimeContainer.style.display = settings.sessionTime.enabled ? 'flex' : 'none';
            settingsModal.classList.replace('hidden', 'flex');
        }

        timeLimitToggle.addEventListener('change', () => timeInputsContainer.style.display = timeLimitToggle.checked ? 'block' : 'none');
        sessionTimeToggle.addEventListener('change', () => sessionTimeContainer.style.display = sessionTimeToggle.checked ? 'flex' : 'none');

        document.getElementById('settings-cancel').onclick = () => settingsModal.classList.replace('flex', 'hidden');

        document.getElementById('settings-save').onclick = async () => {
            const newSettings = {
                canAddFriends: canAddFriendsToggle.checked,
                timeLimits: {
                    enabled: timeLimitToggle.checked,
                    startTime: startTimeInput.value,
                    endTime: endTimeInput.value,
                },
                sessionTime: {
                    enabled: sessionTimeToggle.checked,
                    duration: parseInt(sessionDurationInput.value, 10),
                    unit: sessionUnitSelect.value,
                },
                filters: {
                    textLevel: textFilterSelect.value
                }
            };
            try {
                await updateDoc(doc(db, "users", currentEditingChild.id), { settings: newSettings });
                showNotification(`Ajustes de ${currentEditingChild.name} guardados.`);
                settingsModal.classList.replace('flex', 'hidden');
            } catch (error) { showNotification(`Error al guardar: ${error.message}`); }
        };

        // --- LÓGICA DE HIJO (LÍMITES Y BLOQUEOS) ---
        function checkChildLockState(settings) {
            const timeLimitActive = checkTimeLimits(settings);
            const sessionLimitActive = checkSessionTime(settings);
            const blockMessageEl = document.getElementById('child-block-message');
            
            if (timeLimitActive) {
                blockMessageEl.textContent = `Tu horario de uso es de ${settings.timeLimits.startTime} a ${settings.timeLimits.endTime}.`;
                blockMessageEl.classList.remove('hidden');
            } else if (sessionLimitActive) {
                blockMessageEl.textContent = 'Tu tiempo de sesión ha terminado. Vuelve más tarde.';
                blockMessageEl.classList.remove('hidden');
            } else {
                blockMessageEl.classList.add('hidden');
            }

            const isLocked = timeLimitActive || sessionLimitActive;
            document.getElementById('friends-list').style.display = isLocked ? 'none' : 'block';
            document.getElementById('child-controls').querySelectorAll('h3, .grid').forEach(el => el.style.display = isLocked ? 'none' : 'block');
        }

        function checkTimeLimits(settings) {
            if (!settings?.timeLimits?.enabled || !settings.timeLimits.startTime || !settings.timeLimits.endTime) return false;
            const { startTime, endTime } = settings.timeLimits;
            const now = new Date(Date.now() + timeOffset);
            const currentTime = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
            return !(currentTime >= startTime && currentTime < endTime);
        }
        
        function checkSessionTime(settings) {
            if (!settings?.sessionTime?.enabled) return false;
            
            const loginTime = auth.currentUser.metadata.lastSignInTime;
            if (!loginTime) return false;
            
            const sessionStart = new Date(loginTime).getTime();
            const now = Date.now() + timeOffset;

            let durationMs = settings.sessionTime.duration;
            if (settings.sessionTime.unit === 'minutes') {
                durationMs *= 60000;
            } else { // hours
                durationMs *= 3600000;
            }

            return (now - sessionStart) > durationMs;
        }
        
        function updateChildControls(settings) {
            const canAdd = settings?.canAddFriends ?? true;
            document.getElementById('show-qr-button').style.display = canAdd ? 'flex' : 'none';
            document.getElementById('scan-qr-button').style.display = canAdd ? 'flex' : 'none';
            document.getElementById('add-friends-disabled-msg').style.display = canAdd ? 'none' : 'block';
            checkChildLockState(settings);
        }

        async function updateUsage(childId) {
            if (checkChildLockState(currentUserData.settings)) return; // No contar si está bloqueado
            const date = new Date(Date.now() + timeOffset);
            const dateString = date.toISOString().split('T')[0];
            const usageRef = doc(db, 'users', childId, 'usage', dateString);
            await setDoc(usageRef, { totalMinutes: increment(1) }, { merge: true });
        }

        // --- FILTRO DE CONTENIDO Y NOTIFICACIONES ---
        let profanityFilters = {};

        async function loadFilters() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/Logise1/filters/refs/heads/main/filters.json');
                if (!response.ok) throw new Error('Network response was not ok');
                const filters = await response.json();
                profanityFilters = {
                    high: [...filters.high, ...filters.medium, ...filters.low],
                    medium: [...filters.medium, ...filters.low],
                    low: [...filters.low]
                };
                logToScreen("Filtros de contenido cargados exitosamente.");
            } catch (error) {
                logToScreen('Error al cargar los filtros, usando filtro básico: ' + error);
                profanityFilters = { high: ['mierda', 'joder', 'puto', 'puta', 'cabron', 'gilipollas', 'tonto', 'idiota'], medium: ['tonto', 'idiota'], low: [] };
            }
        }
        loadFilters();

        function filterMessage(text, level) {
            const wordsToFilter = profanityFilters[level] || [];
            if (wordsToFilter.length === 0) return null;
            const regex = new RegExp(`\\b(${wordsToFilter.join('|')})\\b`, 'gi');
            const match = text.match(regex);
            return match ? match[0] : null;
        }

        async function createInfractionNotification(message, word) {
            if (!currentUserData || !currentUserData.parentId) return;
            try {
                await addDoc(collection(db, "notifications"), {
                    parentId: currentUserData.parentId,
                    childId: currentUser.uid,
                    childName: currentUserData.name,
                    message: message,
                    word: word,
                    timestamp: serverTimestamp(),
                    read: false
                });
                logToScreen('Infraction notification created.');
            } catch (error) {
                logToScreen('Error creating infraction notification: ' + error);
            }
        }

        function setupNotifications() {
            const bell = document.getElementById('notification-bell');
            const badge = document.getElementById('notification-badge');
            const modal = document.getElementById('notifications-modal');
            const list = document.getElementById('notifications-list');

            const q = query(collection(db, "notifications"), where("parentId", "==", currentUser.uid), orderBy("timestamp", "desc"));
            
            unsubscribeNotifications = onSnapshot(q, (snapshot) => {
                list.innerHTML = snapshot.empty ? '<p class="text-gray-500 text-center p-4">No hay notificaciones.</p>' : '';
                let unreadCount = 0;

                snapshot.forEach(notifDoc => {
                    const notification = { id: notifDoc.id, ...notifDoc.data() };
                    if (!notification.read) unreadCount++;

                    const el = document.createElement('div');
                    el.className = `p-3 rounded-lg border ${notification.read ? 'bg-white/30 border-gray-200' : 'bg-indigo-100 border-indigo-200'}`;
                    el.innerHTML = `
                        <p class="text-sm text-gray-800"><strong>${notification.childName}</strong> intentó enviar un mensaje bloqueado:</p>
                        <p class="text-xs text-gray-600 italic my-1 p-2 bg-gray-50 rounded">"${notification.message}"</p>
                        <p class="text-xs text-gray-500">Palabra detectada: <strong class="text-red-500">${notification.word}</strong></p>
                        <div class="text-right text-xs text-gray-400 mt-2">${notification.timestamp ? notification.timestamp.toDate().toLocaleString() : ''}</div>
                    `;
                    el.onclick = () => updateDoc(doc(db, "notifications", notification.id), { read: true });
                    list.appendChild(el);
                });

                badge.classList.toggle('hidden', unreadCount === 0);
            });

            bell.onclick = () => modal.classList.replace('hidden', 'flex');
            document.getElementById('close-notifications-modal').onclick = () => modal.classList.replace('flex', 'hidden');
        }

    </script>
</body>
</html>
