<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - LoopChat</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Biblioteca para generar códigos QR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Biblioteca para escanear códigos QR -->
    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <!-- Fuente Inter de Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --brand-color: #6366F1;
            --brand-color-light: #E0E7FF;
        }
        html, body {
            height: 100%;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }
        body { 
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to bottom right, #f3e8ff, #dbeafe);
        }
        .screen { display: none; }
        .active-screen { display: flex; }

        .app-container {
            height: 100vh;
            height: calc(var(--vh, 1vh) * 100);
            background-color: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .glass-modal {
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(15px);
             -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        .glass-card {
             background-color: rgba(255, 255, 255, 0.5);
             border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .message { max-width: 75%; padding: 10px 14px; border-radius: 20px; margin-bottom: 4px; word-wrap: break-word; display: flex; flex-direction: column; }
        .sent { background-color: var(--brand-color); color: white; align-self: flex-end; border-bottom-right-radius: 6px; }
        .received { background-color: #F3F4F6; color: #111827; align-self: flex-start; border-bottom-left-radius: 6px; }
        .timestamp { font-size: 0.7rem; color: #ffffff99; align-self: flex-end; margin-top: 4px; }
        .received .timestamp { color: #6B7280; }

        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
        .typing-indicator span { animation: bounce 1.2s infinite ease-in-out; display: inline-block; width: 6px; height: 6px; background-color: #9CA3AF; border-radius: 50%; margin: 0 1px; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center">

    <div class="app-container w-full max-w-md mx-auto md:rounded-2xl shadow-lg flex flex-col">
        
        <div id="loading-screen" class="screen active-screen flex-1 flex-col items-center justify-center p-6 md:p-8">
             <svg class="animate-spin h-10 w-10 text-[var(--brand-color)]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
             <p class="mt-4 text-gray-600 font-medium">Cargando...</p>
        </div>

        <div id="child-dashboard-screen" class="screen flex-1 flex-col h-full">
             <div class="p-6 md:p-8 pb-4 flex-shrink-0">
                <div class="w-full flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">Hola, <span id="child-name-display"></span>!</h2>
                    <button id="logout-button-child" title="Cerrar sesión" class="text-gray-500 hover:text-[var(--brand-color)] transition"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg></button>
                </div>
                <div id="child-block-message" class="hidden text-center text-sm text-red-600 my-4 p-3 bg-red-100 rounded-lg"></div>
                <div id="parent-chat-container" class="w-full"></div>
            </div>
            <div class="flex flex-col flex-1 overflow-hidden px-6 md:px-8 pb-6">
                <div id="child-controls" class="w-full flex-shrink-0">
                    <div class="grid grid-cols-2 gap-4 w-full my-6 flex-shrink-0">
                        <button id="show-qr-button" class="bg-green-500 text-white font-bold py-3 rounded-xl hover:bg-green-600 transition shadow-sm flex items-center justify-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>Mi QR</button>
                        <button id="scan-qr-button" class="bg-blue-500 text-white font-bold py-3 rounded-xl hover:bg-blue-600 transition shadow-sm flex items-center justify-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7V5a2 2 0 0 1 2-2h2"></path><path d="M17 3h2a2 2 0 0 1 2 2v2"></path><path d="M21 17v2a2 2 0 0 1-2 2h-2"></path><path d="M7 21H5a2 2 0 0 1-2-2v-2"></path></svg>Escanear</button>
                    </div>
                    <div id="add-friends-disabled-msg" class="hidden text-center text-sm text-gray-500 my-2 p-3 bg-gray-100 rounded-lg">Tu padre ha desactivado la opción de añadir amigos.</div>
                    <h3 class="font-bold text-gray-700 mb-2 w-full flex-shrink-0">Amigos:</h3>
                </div>
                <div id="friends-list" class="w-full space-y-2 flex-1 overflow-y-auto"></div>
            </div>
        </div>
        
        <div id="chat-screen" class="screen flex-1 w-full h-full flex-col">
            <div class="w-full flex items-center p-6 md:p-8 pb-4 border-b flex-shrink-0">
                <button id="back-to-dashboard" class="mr-3 text-gray-500 hover:text-[var(--brand-color)]">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
                </button>
                <div>
                    <h2 class="text-lg font-bold text-gray-800" id="chat-with-name"></h2>
                    <div id="chat-status" class="text-xs text-gray-500 h-4"></div>
                </div>
            </div>
            <div id="messages-container" class="flex-1 w-full px-4 pt-4 overflow-y-auto flex flex-col-reverse">
                <div id="messages-list" class="flex flex-col gap-1"></div>
            </div>
            <div class="p-6 md:p-8 pt-4 flex-shrink-0">
                <form id="message-form" class="w-full flex gap-2 items-center">
                    <input type="text" id="message-input" placeholder="Escribe un mensaje..." class="flex-1 px-4 py-2 border border-gray-300 bg-gray-100 rounded-full focus:outline-none focus:ring-2 focus:ring-[var(--brand-color)]" autocomplete="off">
                    <button type="submit" id="send-btn" class="bg-[var(--brand-color)] text-white rounded-full p-3 flex items-center justify-center hover:bg-[var(--brand-color-dark)] transition shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>
                    </button>
                </form>
            </div>
        </div>

        <div id="qr-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50">
            <div class="bg-white p-8 rounded-2xl shadow-xl text-center flex flex-col items-center glass-modal">
                <h3 class="text-xl font-bold mb-4">Muestra este QR a tu amigo</h3>
                <div id="qrcode-container" class="p-2 border rounded-lg w-[208px] h-[208px]"></div>
                <p class="text-sm text-gray-500 mt-2">Este código cambia muy rápido por seguridad.</p>
                <button id="close-qr-modal" class="mt-6 bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">Cerrar</button>
            </div>
        </div>
        <div id="scan-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50">
             <div class="bg-white p-6 rounded-2xl shadow-xl text-center w-11/12 max-w-lg glass-modal">
                <h3 class="text-xl font-bold mb-2">Escanea el QR de tu amigo</h3>
                <div id="qr-reader" class="w-full border rounded-lg overflow-hidden"></div>
                <button id="close-scan-modal" class="mt-6 bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">Cancelar</button>
            </div>
        </div>
         <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50">
             <div class="bg-white p-6 rounded-2xl shadow-xl text-center w-11/12 max-w-sm glass-modal">
                <h3 id="confirm-title" class="text-lg font-bold mb-2">¿Estás seguro?</h3>
                <p id="confirm-message" class="text-gray-600 mb-6">Esta acción no se puede deshacer.</p>
                <div class="flex gap-4">
                    <button id="confirm-cancel" class="flex-1 bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Cancelar</button>
                    <button id="confirm-accept" class="flex-1 bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600">Aceptar</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="notification" class="fixed bottom-5 right-5 bg-gray-900 text-white py-2 px-5 rounded-full shadow-lg opacity-0 transform translate-y-3 transition-all duration-300 pointer-events-none z-50">
        <p id="notification-message"></p>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs, addDoc, onSnapshot, orderBy, serverTimestamp, deleteDoc, limit, updateDoc, writeBatch, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyC1XbhA7TTz7gn-3_SFJ53p7DPfq36eRdg",
            authDomain: "safechat-224e2.firebaseapp.com",
            projectId: "safechat-224e2",
            storageBucket: "safechat-224e2.firebasestorage.app",
            messagingSenderId: "390500687585",
            appId: "1:390500687585:web:36fc0ce72b58e02351e1a0"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null, currentUserData = null, html5QrCode = null;
        let unsubscribeUserStatus = () => {}, unsubscribeFriends = () => {}, unsubscribeCurrentChat = () => {}, unsubscribeTyping = () => {};
        let friendStatusUnsubscribers = {};
        let timeLimitInterval;
        let usageInterval;
        let timeOffset = 0;
        
        const showScreen = (screenId) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
            document.getElementById(screenId).classList.add('active-screen');
        };

        const setVh = () => {
            document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
        };
        window.addEventListener('resize', setVh);
        setVh();
        
        function showNotification(message) {
            const el = document.getElementById('notification'), msgEl = document.getElementById('notification-message');
            msgEl.textContent = message;
            el.classList.remove('opacity-0', 'translate-y-3');
            setTimeout(() => el.classList.add('opacity-0', 'translate-y-3'), 2500);
        }

        function showConfirmation(title, message, onAccept) {
            const modal = document.getElementById('confirm-modal');
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-message').textContent = message;
            modal.classList.replace('hidden', 'flex');
            const acceptBtn = document.getElementById('confirm-accept');
            const cancelBtn = document.getElementById('confirm-cancel');
            const close = () => modal.classList.replace('flex', 'hidden');
            acceptBtn.onclick = () => { close(); onAccept(); };
            cancelBtn.onclick = close;
        }

        const updateUserOnlineStatus = async (isOnline) => {
            if (!auth.currentUser) return;
            try {
                await updateDoc(doc(db, "users", auth.currentUser.uid), { isOnline, lastSeen: serverTimestamp() });
            } catch (e) { console.error("Error updating status:", e) }
        };
        window.addEventListener('beforeunload', () => updateUserOnlineStatus(false));

        async function syncTime() {
            try {
                const timeSyncRef = doc(db, 'meta/timeSync');
                await setDoc(timeSyncRef, { time: serverTimestamp() });
                const docSnap = await getDoc(timeSyncRef);
                const serverNow = docSnap.data().time.toMillis();
                timeOffset = serverNow - Date.now();
            } catch(e) { console.error("Error al sincronizar la hora:", e); timeOffset = 0; }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                await user.reload();
                await syncTime();
                const userDocSnap = await getDoc(doc(db, "users", user.uid));
                if (userDocSnap.exists()) {
                    currentUser = user;
                    currentUserData = userDocSnap.data();

                    if (currentUserData.role === 'parent') {
                        window.location.href = 'parental.html';
                        return;
                    }
                    
                    await updateUserOnlineStatus(true);

                    unsubscribeUserStatus = onSnapshot(doc(db, "users", user.uid), (snap) => {
                        currentUserData = snap.data();
                        updateChildControls(currentUserData.settings);
                    });

                    await setupChildDashboard();

                } else {
                    await signOut(auth);
                }
            } else {
                window.location.href = 'index.html';
            }
        });
        
        document.getElementById('logout-button-child').addEventListener('click', async () => {
            await updateUserOnlineStatus(false);
            await signOut(auth);
        });

        async function setupChildDashboard() {
            if (!currentUserData.parentId) {
                showNotification("Tu cuenta ha sido desvinculada.");
                await signOut(auth);
                return;
            }

            const parentDoc = await getDoc(doc(db, "users", currentUserData.parentId));
            if (!parentDoc.exists()) {
                showNotification("La cuenta de tu padre/madre ya no existe.");
                await signOut(auth);
                return;
            }
            const parentData = parentDoc.data();

            document.getElementById('child-name-display').textContent = currentUserData.name;
            const parentChatContainer = document.getElementById('parent-chat-container');
            parentChatContainer.innerHTML = `<h3 class="font-bold text-gray-700 mb-2 w-full flex-shrink-0">Chat Seguro</h3><div id="parent-chat-btn" class="w-full text-left bg-yellow-100 p-3 rounded-xl hover:bg-yellow-200 transition flex items-center justify-between cursor-pointer"><div class="flex items-center gap-3"><div class="relative"><div class="w-10 h-10 rounded-full bg-yellow-200 flex items-center justify-center font-bold text-yellow-600">P</div></div><span class="font-semibold text-gray-800">${parentData.name} (Padre/Madre)</span></div></div>`;
            document.getElementById('parent-chat-btn').onclick = () => openChat(currentUserData.parentId, parentData.name);
            
            clearInterval(timeLimitInterval);
            clearInterval(usageInterval);
            timeLimitInterval = setInterval(() => checkChildLockState(currentUserData.settings), 30000);
            usageInterval = setInterval(() => updateUsage(currentUser.uid), 60000);
            
            if(checkChildLockState(currentUserData.settings)) return;

            showScreen('child-dashboard-screen');
            
            const q = query(collection(db, "friendships"), where("users", "array-contains", currentUser.uid));
            unsubscribeFriends = onSnapshot(q, (snapshot) => {
                document.getElementById('friends-list').innerHTML = snapshot.empty ? '<p class="text-gray-400 text-center w-full">¡Añade amigos escaneando su QR!</p>' : '';
                Object.values(friendStatusUnsubscribers).forEach(unsub => unsub());
                friendStatusUnsubscribers = {};
                snapshot.forEach(async (docSnap) => {
                    const friendId = docSnap.data().users.find(id => id !== currentUser.uid);
                    const friendDocRef = doc(db, "users", friendId);
                    const friendDoc = await getDoc(friendDocRef);
                    if (friendDoc.exists()) {
                        const friendData = friendDoc.data();
                        const friendEl = document.createElement('div');
                        friendEl.id = `friend-${friendId}`;
                        friendEl.className = 'w-full text-left glass-card p-3 rounded-xl hover:bg-white/70 transition flex items-center justify-between cursor-pointer';
                        friendEl.innerHTML = `<div class="flex items-center gap-3"><div class="relative"><div class="w-10 h-10 rounded-full bg-indigo-200 flex items-center justify-center font-bold text-indigo-600">${friendData.name.charAt(0)}</div><div id="status-${friendId}" class="absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-white ${friendData.isOnline ? 'bg-green-500' : 'bg-gray-400'}"></div></div><span class="font-semibold text-gray-800">${friendData.name}</span></div><button class="delete-friend-btn text-gray-400 hover:text-red-500 p-1 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></button>`;
                        friendEl.querySelector('.delete-friend-btn').addEventListener('click', (e) => { e.stopPropagation(); showConfirmation('Eliminar Amigo', `¿Seguro que quieres eliminar a ${friendData.name}?`, () => deleteDoc(doc(db, "friendships", docSnap.id))); });
                        friendEl.addEventListener('click', () => openChat(friendId, friendData.name));
                        document.getElementById('friends-list').appendChild(friendEl);
                        friendStatusUnsubscribers[friendId] = onSnapshot(friendDocRef, (snap) => {
                            const statusEl = document.getElementById(`status-${friendId}`);
                            if (statusEl) statusEl.className = `absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-white ${snap.data().isOnline ? 'bg-green-500' : 'bg-gray-400'}`;
                        });
                    }
                });
            });
        }
        
        let qrTimerInterval, qrTokenCleanupTimeout;
        const startQrModal = async () => {
            document.getElementById('qr-modal').classList.replace('hidden', 'flex');
            const token = `QR_${currentUser.uid}_${Date.now()}`;
            await setDoc(doc(db, "qr_tokens", currentUser.uid), { token, expires: new Date(Date.now() + 30000) });
            qrTokenCleanupTimeout = setTimeout(() => deleteDoc(doc(db, "qr_tokens", currentUser.uid)), 31000);
            const generateVisual = () => {
                document.getElementById('qrcode-container').innerHTML = '';
                new QRCode(document.getElementById('qrcode-container'), { text: JSON.stringify({ userId: currentUser.uid, token, nonce: Date.now() }), width: 192, height: 192 });
            };
            generateVisual();
            qrTimerInterval = setInterval(generateVisual, 500);
        };
        const closeQrModal = () => {
            document.getElementById('qr-modal').classList.replace('flex', 'hidden');
            clearInterval(qrTimerInterval);
            clearTimeout(qrTokenCleanupTimeout);
            deleteDoc(doc(db, "qr_tokens", currentUser.uid));
        };
        
        const startScanModal = () => {
            document.getElementById('scan-modal').classList.replace('hidden', 'flex');
            html5QrCode = new Html5Qrcode("qr-reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, async (text) => {
                stopScanner();
                showNotification('Procesando QR...');
                try {
                    const data = JSON.parse(text);
                    if (!data.userId || !data.token) throw new Error("QR no válido.");
                    if (data.userId === currentUser.uid) throw new Error("No puedes agregarte a ti mismo.");
                    const friendshipId = [currentUser.uid, data.userId].sort().join('_');
                    if ((await getDoc(doc(db, "friendships", friendshipId))).exists()) throw new Error("¡Ya sois amigos!");
                    const tokenDoc = await getDoc(doc(db, "qr_tokens", data.userId));
                    if (!tokenDoc.exists() || tokenDoc.data().expires.toDate() < new Date()) throw new Error("El código QR ha expirado.");

                    const batch = writeBatch(db);
                    const friendshipRef = doc(db, "friendships", friendshipId);
                    batch.set(friendshipRef, { users: [currentUser.uid, data.userId].sort() });
                    const tokenRef = doc(db, "qr_tokens", data.userId);
                    batch.delete(tokenRef);
                    await batch.commit();
                    
                    showNotification("¡Amigo agregado con éxito!");
                } catch (error) { showNotification(error.message.includes("JSON") ? "QR no válido." : `Error: ${error.message}`); }
            }, () => {});
        };
        const stopScanner = () => {
            if (html5QrCode && html5QrCode.isScanning) html5QrCode.stop().catch(console.error);
            document.getElementById('scan-modal').classList.replace('flex', 'hidden');
        };
        
        document.getElementById('show-qr-button').onclick = startQrModal;
        document.getElementById('close-qr-modal').onclick = closeQrModal;
        document.getElementById('scan-qr-button').onclick = startScanModal;
        document.getElementById('close-scan-modal').onclick = stopScanner;

        let currentChatId = null, typingTimeout = null;
        
        function openChat(friendId, friendName, readOnly = false, viewerId = currentUser.uid) {
            showScreen('chat-screen');
            currentChatId = [viewerId, friendId].sort().join('_');
            document.getElementById('chat-with-name').textContent = friendName;
            document.getElementById('message-form').style.display = readOnly ? 'none' : 'flex';
            
            const messagesList = document.getElementById('messages-list');
            messagesList.innerHTML = '';
            
            const q = query(collection(db, "chats", currentChatId, "messages"), orderBy("timestamp", "desc"), limit(50));
            unsubscribeCurrentChat = onSnapshot(q, (snapshot) => {
                messagesList.innerHTML = '';
                snapshot.docs.reverse().forEach(msgDoc => {
                    const message = msgDoc.data();
                    const el = document.createElement('div');
                    let content = `<span>${message.text || ''}</span>`;
                    
                    el.className = `message ${message.senderId === viewerId ? 'sent' : 'received'}`;
                    const time = message.timestamp ? message.timestamp.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
                    el.innerHTML = `${content}<span class="timestamp">${time}</span>`;
                    messagesList.appendChild(el);
                });
                 document.getElementById('messages-container').scrollTop = document.getElementById('messages-container').scrollHeight;
            });

            if (!readOnly) {
                const typingRef = doc(db, "typing_status", currentChatId);
                unsubscribeTyping = onSnapshot(typingRef, (snap) => {
                    const statusEl = document.getElementById('chat-status');
                    if (snap.exists() && snap.data()[friendId]) {
                        statusEl.innerHTML = `<div class="typing-indicator"><span></span><span></span><span></span></div>`;
                    } else {
                        statusEl.innerHTML = '';
                    }
                });
            }
        }
        
        document.getElementById('message-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = document.getElementById('message-input');
            let messageText = input.value.trim();
            if (messageText && currentChatId) {
                const filterLevel = currentUserData.settings?.filters?.textLevel || 'medium';
                const matchedWord = filterMessage(messageText, filterLevel);
                if (matchedWord) {
                    showNotification("Tu mensaje contiene palabras no permitidas.");
                    await createInfractionNotification(messageText, matchedWord);
                    return;
                }
                await addDoc(collection(db, "chats", currentChatId, "messages"), { text: messageText, senderId: currentUser.uid, timestamp: serverTimestamp(), type: 'text' });
                input.value = '';
            }
        });

        document.getElementById('message-input').addEventListener('input', () => {
            if (!currentChatId) return;
            const typingRef = doc(db, "typing_status", currentChatId);
            clearTimeout(typingTimeout);
            updateDoc(typingRef, { [currentUser.uid]: true }).catch(() => setDoc(typingRef, { [currentUser.uid]: true }));
            typingTimeout = setTimeout(() => updateDoc(typingRef, { [currentUser.uid]: false }), 2000);
        });

        document.getElementById('back-to-dashboard').addEventListener('click', () => {
             unsubscribeCurrentChat();
             unsubscribeTyping();
             showScreen('child-dashboard-screen');
        });
        
        function checkChildLockState(settings) {
            const timeLimitActive = checkTimeLimits(settings);
            const sessionLimitActive = checkSessionTime(settings);
            const blockMessageEl = document.getElementById('child-block-message');
            
            if (timeLimitActive) {
                blockMessageEl.textContent = `Tu horario de uso es de ${settings.timeLimits.startTime} a ${settings.timeLimits.endTime}.`;
                blockMessageEl.classList.remove('hidden');
            } else if (sessionLimitActive) {
                blockMessageEl.textContent = 'Tu tiempo de sesión ha terminado. Vuelve más tarde.';
                blockMessageEl.classList.remove('hidden');
            } else {
                blockMessageEl.classList.add('hidden');
            }

            const isLocked = timeLimitActive || sessionLimitActive;
            document.getElementById('friends-list').style.display = isLocked ? 'none' : 'block';
            document.getElementById('child-controls').querySelectorAll('h3, .grid').forEach(el => el.style.display = isLocked ? 'none' : 'block');
        }

        function checkTimeLimits(settings) {
            if (!settings?.timeLimits?.enabled || !settings.timeLimits.startTime || !settings.timeLimits.endTime) return false;
            const now = new Date(Date.now() + timeOffset);
            const currentTime = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
            return !(currentTime >= settings.timeLimits.startTime && currentTime < settings.timeLimits.endTime);
        }
        
        function checkSessionTime(settings) {
            if (!settings?.sessionTime?.enabled) return false;
            const loginTime = auth.currentUser.metadata.lastSignInTime;
            if (!loginTime) return false;
            const sessionStart = new Date(loginTime).getTime();
            const now = Date.now() + timeOffset;
            let durationMs = settings.sessionTime.duration;
            if (settings.sessionTime.unit === 'minutes') {
                durationMs *= 60000;
            } else {
                durationMs *= 3600000;
            }
            return (now - sessionStart) > durationMs;
        }
        
        function updateChildControls(settings) {
            const canAdd = settings?.canAddFriends ?? true;
            document.getElementById('show-qr-button').style.display = canAdd ? 'flex' : 'none';
            document.getElementById('scan-qr-button').style.display = canAdd ? 'flex' : 'none';
            document.getElementById('add-friends-disabled-msg').style.display = canAdd ? 'none' : 'block';
            checkChildLockState(settings);
        }

        async function updateUsage(childId) {
            if (checkChildLockState(currentUserData.settings)) return;
            const date = new Date(Date.now() + timeOffset);
            const dateString = date.toISOString().split('T')[0];
            const usageRef = doc(db, 'users', childId, 'usage', dateString);
            await setDoc(usageRef, { totalMinutes: increment(1) }, { merge: true });
        }

        let profanityFilters = {};
        async function loadFilters() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/Logise1/filters/refs/heads/main/filters.json');
                if (!response.ok) throw new Error('Network response was not ok');
                const filters = await response.json();
                profanityFilters = {
                    high: [...filters.high, ...filters.medium, ...filters.low],
                    medium: [...filters.medium, ...filters.low],
                    low: [...filters.low]
                };
                logToScreen("Filtros de contenido cargados exitosamente.");
            } catch (error) {
                logToScreen('Error al cargar los filtros, usando filtro básico: ' + error);
                profanityFilters = { high: ['mierda', 'joder', 'puto', 'puta', 'cabron', 'gilipollas', 'tonto', 'idiota'], medium: ['tonto', 'idiota'], low: [] };
            }
        }
        loadFilters();

        function filterMessage(text, level) {
            const wordsToFilter = profanityFilters[level] || [];
            if (wordsToFilter.length === 0) return null;
            const regex = new RegExp(`\\b(${wordsToFilter.join('|')})\\b`, 'gi');
            const match = text.match(regex);
            return match ? match[0] : null;
        }

        async function createInfractionNotification(message, word) {
            if (!currentUserData || !currentUserData.parentId) return;
            try {
                await addDoc(collection(db, "notifications"), {
                    parentId: currentUserData.parentId,
                    childId: currentUser.uid,
                    childName: currentUserData.name,
                    message: message,
                    word: word,
                    timestamp: serverTimestamp(),
                    read: false
                });
                logToScreen('Infraction notification created.');
            } catch (error) {
                logToScreen('Error creating infraction notification: ' + error);
            }
        }
    </script>
</body>
</html>
